#!/usr/bin/env node

const SerialPort = require('serialport')
const WebSocket = require('ws');

const path = process.argv[2]
const port = new SerialPort(path, { baudRate: 115200 }, (err) => {
  if (err) {
    return console.error(err)
  }
  console.log(`Serial port ${path} open, connecting to server`)
  const ws = new WebSocket('wss://onyx.ngrok.io/m2?pin=1379');
  ws.on('open', () => {
    console.log(`Server connected, starting relay`)
    const outbound = createWebSocketStream(ws)
    port.pipe(outbound)
  })
})
